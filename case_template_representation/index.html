<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Case Template Representation Viewer</title>
  <style>
    :root{
      --bg: #f4f7fb;
      --panel: #ffffff;
      --accent: #2563eb;
      --muted: #6b7280;
      --danger: #dc2626;
      --card: #f8fafc;
      --success: #16a34a;
      --tier-1: #065f46;
      --tier-2: #2563eb;
      --tier-3: #7c3aed;
      --tier-4: #d97706;
    }

    html, body { height:100%; margin:0; background:var(--bg); font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; color:#0f172a; }
    .wrap { display:flex; height:100vh; gap:18px; padding:18px; box-sizing:border-box }
    .panel { background:var(--panel); border-radius:12px; box-shadow: 0 6px 20px rgba(15,23,42,0.06); padding:18px; width:100%; overflow:auto }

    h1{font-size:18px;margin:0 0 4px 0;color:#0b1220}
    .small{font-size:13px;color:var(--muted)}

    .topbar{display:flex;align-items:center;gap:16px;margin-bottom:12px}
    .topbar .left{flex:1}
    .topbar .right{display:flex;align-items:center;gap:12px}

    select{padding:10px 12px;border-radius:10px;border:1px solid #e6eefc;background:#fff;box-shadow:none}
    .controls{display:flex;gap:12px;align-items:center;width:100%}
    .controls select{flex:1;margin-right:8px;min-width:240px}
    .btn-group{display:flex;gap:8px}
    .secondary{background:#fff;border:1px solid #e6eefc;color:#0f172a;border-radius:10px;padding:8px 14px;cursor:pointer;min-width:150px;height:40px;display:inline-flex;align-items:center;justify-content:center}
    .secondary:hover{box-shadow:0 4px 12px rgba(37,99,235,0.08);transform:translateY(-1px)}

    .match-badges{display:flex;gap:8px;align-items:center;margin:8px 0;flex-wrap:wrap}
    .badge{padding:8px 12px;border-radius:999px;background:var(--card);font-weight:700;color:#0b1220;cursor:default}
    .badge.clickable{cursor:pointer;opacity:0.95}
    .badge.clickable:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(2,6,23,0.06)}
    .badge.active{outline:3px solid rgba(37,99,235,0.12)}
    .badge.template{background:linear-gradient(90deg,#e6eefc,#dbeafe);color:#0b1720}
    .badge.case{background:linear-gradient(90deg,#ecfdf5,#bbf7d0);color:#064e3b}

    table.viewer{width:100%;border-collapse:separate;border-spacing:0;margin-top:12px;background:transparent}
    table.viewer thead th{background:#f1f5f9;color:#0b1220;padding:12px 14px;text-align:left;font-weight:700;border-bottom:1px solid rgba(15,23,42,0.04)}
    table.viewer td{Padding:14px;border-bottom:1px solid rgba(15,23,42,0.04);vertical-align:top}
    table.viewer tbody tr:hover{background:rgba(37,99,235,0.03)}

    .tier-header td{color:#fff;font-weight:700;padding:10px 14px}
    .example-cell{white-space:normal}
    .missing{background:#fff1f2;color:var(--danger);padding:6px 10px;border-radius:999px;font-weight:700}

    pre{background:#0b1220;color:#e6eefc;padding:12px;border-radius:8px;overflow:auto}
    .help{font-size:13px;color:var(--muted);margin-top:8px}
    @media(max-width:900px){.wrap{flex-direction:column}.panel{height:auto}.controls{flex-direction:column;align-items:stretch}.btn-group{justify-content:flex-end}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel" style="width:100%">
            <div class="topbar">
              <div class="left">
                <h1>Case Template Representation</h1>
                <div class="small">Select a template to view its fields and one matched example.</div>
              </div>
              <div class="right">
                <div class="controls" style="min-width:420px">
                  <select id="templateSelect" aria-label="Select template"><option>Loading templates...</option></select>
                  <div class="btn-group">
                    <button id="rawToggle" class="secondary">Show raw JSON</button>
                    <button id="rawTemplateToggle" class="secondary">Show raw template</button>
                  </div>
                </div>
              </div>
            </div>

            <div id="matchInfo" class="match-badges" aria-live="polite"></div>

            <div id="viewerContainer"></div>

            <div id="rawJson" style="display:none;margin-top:12px"><pre id="rawPre"></pre></div>
            <div id="rawTemplate" style="display:none;margin-top:12px"><pre id="rawTemplatePre"></pre></div>
          </div>
        </div>

        <script>
          const templateSelect = document.getElementById('templateSelect');
          const viewerContainer = document.getElementById('viewerContainer');
          const rawToggle = document.getElementById('rawToggle');
          const rawPre = document.getElementById('rawPre');
          const rawJson = document.getElementById('rawJson');

          let templatesIndex = [];
          let exampleFiles = [];
          let currentTemplate = null;
          let currentExample = null;

          // Accessibility: add ARIA labels
          templateSelect.setAttribute('aria-label','Template selector');
          rawToggle.setAttribute('aria-pressed','false');

          function tierColorFor(tierName){
            const map = {
              'tier_1_determinative':'#065f46',
              'tier_2_material':'#2563eb',
              'tier_3_contextual':'#7c3aed',
              'tier_4_procedural':'#d97706',
              'residual_details':'#374151'
            };
            for(const k of Object.keys(map)){
              if(tierName.toLowerCase().includes(k.replace(/_/g,' ')) || tierName.toLowerCase()===k) return map[k];
            }
            return '#6b7280';
          }

          function cleanCaseName(fname){ if(!fname) return ''; try{ fname = decodeURIComponent(fname); }catch(e){} return fname.replace(/_facts\.json$/i,'').replace(/\.json$/i,''); }

          async function tryFetchJson(path){ try{const r = await fetch(path); if(!r.ok) throw new Error('no'); const j = await r.json(); return j}catch(e){return null} }

          async function listDirJson(dirUrl){
            try{
              const r = await fetch(dirUrl);
              if(!r.ok) return [];
              const text = await r.text();
              const parser = new DOMParser();
              const doc = parser.parseFromString(text,'text/html');
              const links = Array.from(doc.querySelectorAll('a')).map(a=>a.getAttribute('href'))
                .filter(h=>h && h.endsWith('.json'))
                .map(h=> (dirUrl.endsWith('/')?dirUrl:dirUrl + '/') + h.replace(/\/?$/, ''));
              return links.map(l=>{ try{const u = new URL(l, location.href); return u.pathname;}catch(e){return l} });
            }catch(e){return []}
          }

          async function loadTemplates(){
            // load manifest and templates from the local `templates/` folder inside this viewer
            const templatesManifest = await tryFetchJson('templates/templates.json');
            if(templatesManifest && templatesManifest.templates){ templatesIndex = templatesManifest.templates.map(t=>({id:t.node_id,label:t.label,entry:t})); }
            const discovered = await listDirJson('templates');
            for(const p of discovered){
              const name = p.split('/').pop();
              if(templatesIndex.find(t=>t.id===name.replace('.json','')) ) continue;
              const j = await tryFetchJson(p);
              if(j && (j.node_id || j.json_schema)){
                templatesIndex.push({id: name.replace('.json',''), label: j.label || name.replace('.json',''), entry: j});
              }
            }
            templatesIndex.sort((a,b)=>a.label.localeCompare(b.label));
            templateSelect.innerHTML = templatesIndex.map(t=>`<option value="${t.id}">${t.label}</option>`).join('');
            templateSelect.addEventListener('change', onTemplateChange);
          }

          async function loadExamples(){ const discovered = await listDirJson('extracted'); exampleFiles = discovered.filter(p=>p.toLowerCase().includes('_facts.json')); exampleFiles.sort(); }

          function renderTemplate(t){
            currentTemplate = t;
            if(!t){viewerContainer.innerHTML = '<div class="small">No template</div>';return}
            if(t.entry && t.entry.json_schema){
              const schema = t.entry.json_schema.schema;
              const tiers = schema.properties || {};
              let html = '';
              html += `<table class="viewer" aria-describedby="template-table"><thead><tr><th style="width:25%">Field</th><th style="width:25%">Description</th><th style="width:50%">Example value</th></tr></thead><tbody>`;
              for(const tierName of Object.keys(tiers)){
                const color = tierColorFor(tierName);
                html += `<tr class="tier-header" data-tier-name="${tierName}" style="background:${color};color:#fff;font-weight:700"><td colspan="3">${tierName}</td></tr>`;
                const tier = tiers[tierName];
                const props = tier.properties || {};
                for(const [fname, fdef] of Object.entries(props)){
                  html += `<tr data-tier="${tierName}" data-field="${fname}"><td>${fname}</td><td>${escapeHtml(fdef.description||'')}</td><td class="example-cell"></td></tr>`;
                }
              }
              html += `</tbody></table>`;
              viewerContainer.innerHTML = html;
              attachTemplateRowClicks();
              return;
            }
            if(t.entry && t.entry.fact_tiers){
              const tiers = t.entry.fact_tiers;
              let html = `<table class="viewer"><thead><tr><th style="width:25%">Field</th><th style="width:25%">Description</th><th style="width:50%">Example value</th></tr></thead><tbody>`;
              for(const [tierName,tier] of Object.entries(tiers)){
                const color = tierColorFor(tierName);
                html += `<tr class="tier-header" data-tier-name="${tierName}" style="background:${color};color:#fff;font-weight:700"><td colspan="3">${tierName}</td></tr>`;
                for(const fname of (tier.fields||[])){
                  const def = (t.entry.field_definitions && t.entry.field_definitions[fname]) || {};
                  html += `<tr data-tier="${tierName}" data-field="${fname}"><td>${fname}</td><td>${escapeHtml(def.description||'')}</td><td class="example-cell"></td></tr>`;
                }
              }
              html += `</tbody></table>`;
              viewerContainer.innerHTML = html;
              attachTemplateRowClicks();
              return;
            }
            viewerContainer.innerHTML = '<div class="small">Template format not recognized</div>';
          }

          function renderExampleForTemplate(exampleJson, template){
            currentExample = exampleJson;
            rawPre.textContent = JSON.stringify(exampleJson, null, 2);
            const tableRows = viewerContainer.querySelectorAll('tr[data-field]');
            if(!tableRows || tableRows.length===0){ viewerContainer.innerHTML = '<div class="small">No template table to populate. Select a template.</div>'; return; }
            tableRows.forEach(tr=>{
              const fname = tr.getAttribute('data-field');
              const value = getNested(exampleJson, fname);
              const display = (value===undefined||value===null)?'<span class="missing">missing</span>':escapeHtml(String(value));
              const cell = tr.querySelector('.example-cell'); if(cell) cell.innerHTML = display;
              tr.classList.add('clickable');
              tr.addEventListener('click', ()=>{ rawJson.style.display='block'; rawToggle.textContent='Hide raw JSON'; setTimeout(()=> rawJson.scrollIntoView({behavior:'smooth', block:'center'}),120); });
            });
          }

          function findExtraFields(exampleJson, templateTiers){ const flat = flatten(exampleJson); const expected = new Set(); for(const tier of Object.values(templateTiers)){ for(const f of (tier.fields||[])) expected.add(f); } const extras = []; for(const k of Object.keys(flat)){ if(!expected.has(k)) extras.push(k); } return extras.slice(0,50); }

          function attachTemplateRowClicks(){ const tc = viewerContainer; if(!tc) return; Array.from(tc.querySelectorAll('tr[data-field]')).forEach(tr=>{ tr.addEventListener('click', ()=>{ rawJson.style.display='block'; rawToggle.textContent='Hide raw JSON'; setTimeout(()=> rawJson.scrollIntoView({behavior:'smooth', block:'center'}),120); }); }); }

          const rawTemplateToggle = document.getElementById('rawTemplateToggle');
          const rawTemplate = document.getElementById('rawTemplate');
          const rawTemplatePre = document.getElementById('rawTemplatePre');
          if(rawTemplateToggle){ rawTemplateToggle.setAttribute('aria-pressed','false'); rawTemplateToggle.addEventListener('click', ()=>{ const show = rawTemplate.style.display === 'none'; rawTemplate.style.display = show? 'block':'none'; rawTemplateToggle.textContent = show? 'Hide raw template':'Show raw template'; if(show){ const tpl = currentTemplate && (currentTemplate.entry || currentTemplate) || null; rawTemplatePre.textContent = tpl? JSON.stringify(tpl, null, 2) : '{ }'; setTimeout(()=> rawTemplate.scrollIntoView({behavior:'smooth', block:'center'}), 120); } }); }

          function flatten(obj, prefix=''){ const out = {}; if(typeof obj !== 'object' || obj === null) return out; for(const [k,v] of Object.entries(obj)){ const p = prefix?`${prefix}.${k}`:k; if(v && typeof v === 'object' && !Array.isArray(v)){ Object.assign(out, flatten(v, p)); } else { out[p]=v; } } return out; }

          function getNested(obj, key){ if(!obj) return undefined; if(key.includes('.')){ return key.split('.').reduce((acc, k)=> acc && acc[k]!==undefined?acc[k]:undefined, obj); } if(obj[key]!==undefined) return obj[key]; for(const tier of ['tier_1_determinative','tier_2_material','tier_3_contextual','tier_4_procedural','residual_details']){ if(obj[tier] && obj[tier][key] !== undefined) return obj[tier][key]; } const flat = flatten(obj); return flat[key]!==undefined?flat[key]:undefined; }

          function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') }

          async function onTemplateChange(){
            const id = templateSelect.value;
            const t = templatesIndex.find(x=>x.id===id);
            if(!t) return;
            const standalone = await tryFetchJson(`templates/${t.id}.json`);
            if(standalone) t.entry = standalone;
            renderTemplate(t);

            // collect ALL matching examples for this template
            const idMatches = [];
            for(const p of exampleFiles){
              const ex = await tryFetchJson(p);
              if(!ex) continue;
              // exact template_id matches only (case-insensitive)
              const exTid = (ex.template_id || '').toString().toLowerCase();
              const tplId = (t.id || '').toString().toLowerCase();
              if(exTid && tplId && exTid === tplId){ idMatches.push({path: p, json: ex}); }
            }
            const finalMatches = idMatches; // no heuristic fallback

            const mi = document.getElementById('matchInfo');
            if(!mi) return;
            mi.innerHTML = '';
            // template badge
            const tplBadge = document.createElement('div'); tplBadge.className = 'badge template'; tplBadge.textContent = `Template: ${t.label || t.id}`; mi.appendChild(tplBadge);

            if(finalMatches.length){
              // create a badge for each matched case (click to load)
              finalMatches.forEach((m, idx) =>{
                const name = cleanCaseName(m.path.split('/').pop());
                const b = document.createElement('div');
                b.className = 'badge case clickable' + (idx===0? ' active':'');
                b.textContent = name;
                b.dataset.index = idx;
                b.addEventListener('click', ()=>{
                  // deactivate other badges
                  mi.querySelectorAll('.badge.case').forEach(x=>x.classList.remove('active'));
                  b.classList.add('active');
                  renderExampleForTemplate(m.json, t);
                });
                mi.appendChild(b);
              });
              // render first match by default
              currentExample = finalMatches[0].json;
              renderExampleForTemplate(finalMatches[0].json, t);
            } else {
              const noCase = document.createElement('div'); noCase.className = 'badge case'; noCase.textContent = 'Case: no case matched'; mi.appendChild(noCase);
              // Keep the template table visible but remove the Example value column
              const table = viewerContainer.querySelector('table.viewer');
              if(table){
                // remove the third header cell (Example value)
                const ths = table.querySelectorAll('thead th');
                if(ths && ths.length>2) ths[2].remove();
                // remove example cells from each row
                table.querySelectorAll('.example-cell').forEach(td=>td.remove());
                // also remove any inline widths on remaining headers to let columns size naturally
                const remainingThs = table.querySelectorAll('thead th');
                remainingThs.forEach(th=>th.style.width='');
              } else {
                viewerContainer.innerHTML = '<div class="small">No example found for this template</div>';
              }
            }
          }

          // Returns true if the example appears to match the provided template `t`.
          function exampleMatchesTemplate(exampleJson, t){
            if(!exampleJson || !t) return false;
            const textFields = [];
            for(const key of ['tier_4_procedural','acts_and_sections','sections_invoked','residual_details','tier_1_determinative']){
              const v = exampleJson[key];
              if(!v) continue;
              if(typeof v === 'string') textFields.push(v);
              else if(typeof v === 'object') textFields.push(JSON.stringify(v));
            }
            const combined = textFields.join(' ').toLowerCase();
            if(!combined) return false;
            // check template.sections
            if(t.entry && t.entry.sections){
              for(const s of t.entry.sections){ if(combined.includes(String(s).toLowerCase())) return true; }
            }
            // example_terms
            if(t.entry && t.entry.example_terms){
              for(const term of t.entry.example_terms){ if(combined.includes(term.toLowerCase())) return true; }
            }
            // node id like ipc_376
            const nodeMatch = t.id && t.id.match(/ipc_(\d+)/);
            if(nodeMatch){ const num = nodeMatch[1]; if(combined.includes(num)) return true; }
            return false;
          }

          rawToggle.addEventListener('click', ()=>{ const show = rawJson.style.display === 'none'; rawJson.style.display = show? 'block':'none'; rawToggle.textContent = show? 'Hide raw JSON':'Show raw JSON'; if(show){ setTimeout(()=> rawJson.scrollIntoView({behavior:'smooth', block:'center'}), 120); } });

          (async function(){ await loadTemplates(); await loadExamples(); const prefer = templatesIndex.find(t=>t.id==='legal_case' || (t.label && t.label.toLowerCase().includes('legal'))); if(prefer) templateSelect.value = prefer.id; await onTemplateChange(); })();
        </script>

      </body>
      </html>
